# GStreamer Video Encode/Decode Tests

**Copyright (c) Qualcomm Technologies, Inc. and/or its subsidiaries.**  
**SPDX-License-Identifier: BSD-3-Clause-Clear**

---

## Overview

This test suite validates GStreamer video encoding and decoding using V4L2 hardware-accelerated plugins on Qualcomm Linux platforms. Tests cover two resolutions (480p and 4K) for both H.264 and H.265 codecs.

### Test Coverage

**10 Test Cases Total:**
- **H.264 480p Encode**: Hardware encoding at 720x480 using `v4l2h264enc`
- **H.264 4K Encode**: Hardware encoding at 3840x2160 using `v4l2h264enc`
- **H.265 480p Encode**: Hardware encoding at 720x480 using `v4l2h265enc`
- **H.265 4K Encode**: Hardware encoding at 3840x2160 using `v4l2h265enc`
- **H.264 480p Decode**: Hardware decoding at 720x480 using `v4l2h264dec`
- **H.264 4K Decode**: Hardware decoding at 3840x2160 using `v4l2h264dec`
- **H.265 480p Decode**: Hardware decoding at 720x480 using `v4l2h265dec`
- **H.265 4K Decode**: Hardware decoding at 3840x2160 using `v4l2h265dec`
- **VP9 480p Decode**: Hardware decoding at 720x480 using `v4l2vp9dec`
- **VP9 4K Decode**: Hardware decoding at 3840x2160 using `v4l2vp9dec`

**Key Features:**
- H.264/H.265 decode tests use the output files generated by encode tests as input, ensuring end-to-end validation
- VP9 decode tests automatically fetch test clips from GitHub releases if not present locally
- VP9 tests gracefully skip if hardware support is unavailable

---

## Quick Start

```bash
cd Runner/suites/Gstreamer/Video
./run.sh
```

---

## Test Pipelines

### H.264 480p Encode
```bash
videotestsrc num-buffers=300 ! \
  video/x-raw,width=720,height=480,format=NV12,framerate=30/1 ! \
  v4l2h264enc extra-controls="controls,video_bitrate=1000000" ! \
  h264parse ! qtmux ! filesink location=./output_h264_480p.mp4
```

### H.264 4K Encode
```bash
videotestsrc num-buffers=300 ! \
  video/x-raw,width=3840,height=2160,format=NV12,framerate=30/1 ! \
  v4l2h264enc extra-controls="controls,video_bitrate=8000000" ! \
  h264parse ! qtmux ! filesink location=./output_h264_4k.mp4
```

### H.265 480p Encode
```bash
videotestsrc num-buffers=300 ! \
  video/x-raw,width=720,height=480,format=NV12,framerate=30/1 ! \
  v4l2h265enc extra-controls="controls,video_bitrate=1000000" ! \
  h265parse ! qtmux ! filesink location=./output_h265_480p.mp4
```

### H.265 4K Encode
```bash
videotestsrc num-buffers=300 ! \
  video/x-raw,width=3840,height=2160,format=NV12,framerate=30/1 ! \
  v4l2h265enc extra-controls="controls,video_bitrate=8000000" ! \
  h265parse ! qtmux ! filesink location=./output_h265_4k.mp4
```

### H.264 480p Decode (uses encode output)
```bash
filesrc location=./output_h264_480p.mp4 ! qtdemux ! h264parse ! \
  v4l2h264dec ! videoconvert ! video/x-raw,format=NV12 ! fakevideosink
```

### H.264 4K Decode (uses encode output)
```bash
filesrc location=./output_h264_4k.mp4 ! qtdemux ! h264parse ! \
  v4l2h264dec ! videoconvert ! video/x-raw,format=NV12 ! fakevideosink
```

### H.265 480p Decode (uses encode output)
```bash
filesrc location=./output_h265_480p.mp4 ! qtdemux ! h265parse ! \
  v4l2h265dec ! videoconvert ! video/x-raw,format=NV12 ! fakevideosink
```

### H.265 4K Decode (uses encode output)
```bash
filesrc location=./output_h265_4k.mp4 ! qtdemux ! h265parse ! \
  v4l2h265dec ! videoconvert ! video/x-raw,format=NV12 ! fakevideosink
```

### VP9 480p Decode (uses fetched clip)
```bash
filesrc location=./vp9_480p.webm ! matroskademux ! vp9parse ! \
  v4l2vp9dec ! videoconvert ! video/x-raw,format=NV12 ! fakevideosink
```

### VP9 4K Decode (uses fetched clip)
```bash
filesrc location=./vp9_4k.webm ! matroskademux ! vp9parse ! \
  v4l2vp9dec ! videoconvert ! video/x-raw,format=NV12 ! fakevideosink
```

---

## Test Execution Flow

1. **Encode Tests Run First** (generate output files):
   - h264-480p-encode → creates `output_h264_480p.mp4`
   - h264-4k-encode → creates `output_h264_4k.mp4`
   - h265-480p-encode → creates `output_h265_480p.mp4`
   - h265-4k-encode → creates `output_h265_4k.mp4`

2. **H.264/H.265 Decode Tests Use Encode Outputs**:
   - h264-480p-decode → reads `output_h264_480p.mp4`
   - h264-4k-decode → reads `output_h264_4k.mp4`
   - h265-480p-decode → reads `output_h265_480p.mp4`
   - h265-4k-decode → reads `output_h265_4k.mp4`

3. **VP9 Decode Tests Use Fetched Clips**:
   - vp9-480p-decode → reads `vp9_480p.webm` (auto-fetched if missing)
   - vp9-4k-decode → reads `vp9_4k.webm` (auto-fetched if missing)

This ensures that the encoded content is validated by successfully decoding it. VP9 tests validate hardware decode capability using pre-encoded reference clips.

---

## CLI Options

| Option | Description | Default |
|--------|-------------|---------|
| `--timeout S` | Timeout per test (seconds) | 120 |
| `--strict` | Treat warnings as failures | disabled |
| `--no-dmesg` | Disable dmesg scanning | enabled |
| `--stop-on-fail` | Abort on first failure | disabled |
| `--loglevel N` | GStreamer log verbosity | 15 |
| `--repeat N` | Repeat each test N times | 1 |
| `--repeat-delay S` | Delay between repeats | 0 |
| `--repeat-policy all\|any` | Pass criteria | all |
| `--junit FILE` | JUnit XML output | none |
| `--stack auto\|upstream\|downstream` | Video stack | auto |
| `--platform lemans\|monaco\|kodiak` | Platform | auto-detect |
| `--post-test-sleep S` | Sleep after each test | 0 |
| `--vp9-clips-url URL` | VP9 clips download URL | GitHub release |

---

## Examples

### Run all tests (default)
```bash
./run.sh
```

### Run with increased timeout (for 4K tests)
```bash
./run.sh --timeout 180
```

### Run with strict mode
```bash
./run.sh --strict
```

### Run with repeat
```bash
./run.sh --repeat 3 --repeat-delay 5
```

### Generate JUnit XML
```bash
./run.sh --junit video-results.xml
```

### Select video stack
```bash
./run.sh --stack upstream
./run.sh --stack downstream
```

---

## Output Files

### Test Result
- `Gstreamer_Video_Tests.res` - Overall PASS/FAIL/SKIP

### Logs Directory: `logs_Gstreamer_Video_Tests/`
- `h264-480p-encode.log` - H.264 480p encode pipeline log
- `h264-4k-encode.log` - H.264 4K encode pipeline log
- `h265-480p-encode.log` - H.265 480p encode pipeline log
- `h265-4k-encode.log` - H.265 4K encode pipeline log
- `h264-480p-decode.log` - H.264 480p decode pipeline log
- `h264-4k-decode.log` - H.264 4K decode pipeline log
- `h265-480p-decode.log` - H.265 480p decode pipeline log
- `h265-4k-decode.log` - H.265 4K decode pipeline log
- `vp9-480p-decode.log` - VP9 480p decode pipeline log
- `vp9-4k-decode.log` - VP9 4K decode pipeline log
- `summary.txt` - Per-test results summary
- `results.csv` - Machine-readable results
- `dmesg_errors.log` - Kernel error log (if any)

### Generated Media Files
- `output_h264_480p.mp4` - Encoded H.264 480p video
- `output_h264_4k.mp4` - Encoded H.264 4K video
- `output_h265_480p.mp4` - Encoded H.265 480p video
- `output_h265_4k.mp4` - Encoded H.265 4K video

### VP9 Test Clips (auto-fetched)
- `vp9_480p.webm` - VP9 480p reference clip
- `vp9_4k.webm` - VP9 4K reference clip

---

## Validation Criteria

### Pass Criteria
A test PASSES if:
1. GStreamer pipeline exits with code 0
2. No ERROR patterns in log
3. No WARNING patterns (if `--strict` mode)
4. No kernel errors in dmesg (if enabled)
5. For encode tests: Output file is created
6. For decode tests: Input file exists and is successfully decoded

### Error Patterns Detected
- `ERROR:` - General GStreamer errors
- `v4l2.*failed` - V4L2 operation failures
- `negotiation failed` - Format negotiation issues
- `buffer pool activation failed` - Memory allocation failures
- `format not supported` - Unsupported format errors

---

## Resolution Details

### 480p (720x480)
- **Aspect Ratio**: 3:2
- **Bitrate**: 1 Mbps
- **Use Case**: Standard definition, lower bandwidth
- **Frame Count**: 300 frames (10 seconds at 30fps)

### 4K (3840x2160)
- **Aspect Ratio**: 16:9
- **Bitrate**: 8 Mbps
- **Use Case**: Ultra high definition, high quality
- **Frame Count**: 300 frames (10 seconds at 30fps)

---

## Dependencies

### Required GStreamer Plugins
- `v4l2h264dec` - H.264 hardware decoder
- `v4l2h265dec` - H.265 hardware decoder
- `v4l2h264enc` - H.264 hardware encoder
- `v4l2h265enc` - H.265 hardware encoder
- `v4l2vp9dec` - VP9 hardware decoder (optional, for VP9 tests)
- `qtmux` - MP4 muxer
- `qtdemux` - MP4 demuxer
- `h264parse` - H.264 parser
- `h265parse` - H.265 parser
- `vp9parse` - VP9 parser (optional, for VP9 tests)
- `matroskademux` - WebM/Matroska demuxer (optional, for VP9 tests)
- `videoconvert` - Format converter
- `videotestsrc` - Test pattern generator
- `fakevideosink` - Null sink for validation

### System Requirements
- `/dev/video*` device nodes
- V4L2 video drivers loaded (qcom_iris or iris_vpu)
- GStreamer 1.0 installed
- Sufficient memory for 4K encoding/decoding

---

## Troubleshooting

### Missing Plugins
```bash
# Check plugin availability
gst-inspect-1.0 v4l2h264dec
gst-inspect-1.0 v4l2h264enc
gst-inspect-1.0 v4l2h265dec
gst-inspect-1.0 v4l2h265enc
gst-inspect-1.0 v4l2vp9dec
gst-inspect-1.0 vp9parse
gst-inspect-1.0 matroskademux

# Install packages (if missing)
apt-get install gstreamer1.0-plugins-base \
                gstreamer1.0-plugins-good \
                gstreamer1.0-plugins-bad \
                gstreamer1.0-tools
```

### No Video Devices
```bash
# Check device nodes
ls -la /dev/video*

# Check driver loading
lsmod | grep -E 'iris|venus'

# Check dmesg
dmesg | grep -i video

# Load driver if needed
modprobe qcom_iris
```

### Pipeline Failures
```bash
# Run pipeline manually with verbose output
GST_DEBUG=3 gst-launch-1.0 -v <pipeline>

# Check log file
cat logs_Gstreamer_Video_Tests/h264-480p-encode.log

# Verify format support
v4l2-ctl -d /dev/video0 --list-formats-ext
```

### 4K Encoding Issues
```bash
# Check memory availability
free -h

# Increase timeout for 4K tests
./run.sh --timeout 240

# Check for memory errors in dmesg
dmesg | grep -i "out of memory"
```

### Decode Test Skipped
If H.264/H.265 decode tests are skipped, it means the encode test failed to create the output file:
```bash
# Check if encode test passed
cat logs_Gstreamer_Video_Tests/summary.txt

# Verify output files exist
ls -lh output_*.mp4

# Re-run encode tests only
# (manually run encode pipelines to debug)
```

### VP9 Tests Skipped
VP9 tests may be skipped for several reasons:
```bash
# Check if VP9 plugins are available
gst-inspect-1.0 v4l2vp9dec
gst-inspect-1.0 vp9parse
gst-inspect-1.0 matroskademux

# Check if VP9 clips were fetched
ls -lh vp9_*.webm

# Check network connectivity (for clip fetching)
ping -c 3 github.com

# Manually fetch VP9 clips
wget https://github.com/qualcomm-linux/qcom-linux-testkit/releases/download/IRIS-Video-Files-v1.0/vp9_clips.tar.gz
tar -xzf vp9_clips.tar.gz

# Run with custom VP9 clips URL
./run.sh --vp9-clips-url "https://your-server.com/vp9_clips.tar.gz"
```

### VP9 Decode Failures
```bash
# Run VP9 pipeline manually with verbose output
GST_DEBUG=3 gst-launch-1.0 -v \
  filesrc location=./vp9_480p.webm ! matroskademux ! vp9parse ! \
  v4l2vp9dec ! videoconvert ! fakevideosink

# Check if hardware supports VP9
v4l2-ctl -d /dev/video0 --list-formats-ext | grep VP9

# Check driver capabilities
dmesg | grep -i vp9
```

---


## Supported Platforms

- **LeMans** (QCS9100, QCS9075)
- **Monaco** (QCS8300)
- **Kodiak** (QCS6490, QCM6490)
- **QCS8550, QCS8650**
- **SA8775P, SA8650P, SA8255P**

---

## CI/CD Integration

### LAVA Test Definition
```yaml
- test:
    definitions:
      - repository: <repo-url>
        from: git
        path: Runner/suites/Gstreamer/Video/Gstreamer_Video_Tests.yaml
        name: gstreamer-video-tests
        parameters:
          TIMEOUT: "180"
          STRICT: "false"
          DMESG_SCAN: "true"
```

### Jenkins Pipeline
```groovy
stage('GStreamer Video Tests') {
    steps {
        sh '''
            cd Runner/suites/Gstreamer/Video
            ./run.sh --junit video-results.xml --timeout 180
        '''
        junit 'video-results.xml'
    }
}
```

## License

Copyright (c) Qualcomm Technologies, Inc. and/or its subsidiaries.  
SPDX-License-Identifier: BSD-3-Clause-Clear
